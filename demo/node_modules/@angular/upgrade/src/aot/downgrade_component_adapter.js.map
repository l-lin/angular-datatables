{"version":3,"file":"downgrade_component_adapter.js","sourceRoot":"","sources":["../../../../../modules/@angular/upgrade/src/aot/downgrade_component_adapter.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {ChangeDetectorRef, ComponentFactory, ComponentRef, EventEmitter, Injector, OnChanges, ReflectiveInjector, SimpleChange, SimpleChanges, Type} from '@angular/core';\n\nimport * as angular from '../angular_js';\n\nimport {ComponentInfo, PropertyBinding} from './component_info';\nimport {$SCOPE} from './constants';\n\nconst INITIAL_VALUE = {\n  __UNINITIALIZED__: true\n};\n\nexport class DowngradeComponentAdapter {\n  component: any = null;\n  inputs: Attr;\n  inputChangeCount: number = 0;\n  inputChanges: SimpleChanges = null;\n  componentRef: ComponentRef<any> = null;\n  changeDetector: ChangeDetectorRef = null;\n  componentScope: angular.IScope;\n  childNodes: Node[];\n  contentInsertionPoint: Node = null;\n\n  constructor(\n      private id: string, private info: ComponentInfo, private element: angular.IAugmentedJQuery,\n      private attrs: angular.IAttributes, private scope: angular.IScope,\n      private parentInjector: Injector, private parse: angular.IParseService,\n      private componentFactory: ComponentFactory<any>) {\n    (<any>this.element[0]).id = id;\n    this.componentScope = scope.$new();\n    this.childNodes = <Node[]><any>element.contents();\n  }\n\n  createComponent() {\n    const childInjector = ReflectiveInjector.resolveAndCreate(\n        [{provide: $SCOPE, useValue: this.componentScope}], this.parentInjector);\n    this.contentInsertionPoint = document.createComment('ng1 insertion point');\n\n    this.componentRef = this.componentFactory.create(\n        childInjector, [[this.contentInsertionPoint]], this.element[0]);\n    this.changeDetector = this.componentRef.changeDetectorRef;\n    this.component = this.componentRef.instance;\n  }\n\n  setupInputs(): void {\n    const attrs = this.attrs;\n    const inputs = this.info.inputs || [];\n    for (let i = 0; i < inputs.length; i++) {\n      const input = new PropertyBinding(inputs[i]);\n      let expr: any /** TODO #9100 */ = null;\n\n      if (attrs.hasOwnProperty(input.attr)) {\n        const observeFn = ((prop: any /** TODO #9100 */) => {\n          let prevValue = INITIAL_VALUE;\n          return (value: any /** TODO #9100 */) => {\n            if (this.inputChanges !== null) {\n              this.inputChangeCount++;\n              this.inputChanges[prop] =\n                  new Ng1Change(value, prevValue === INITIAL_VALUE ? value : prevValue);\n              prevValue = value;\n            }\n            this.component[prop] = value;\n          };\n        })(input.prop);\n        attrs.$observe(input.attr, observeFn);\n\n      } else if (attrs.hasOwnProperty(input.bindAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[input.bindAttr];\n      } else if (attrs.hasOwnProperty(input.bracketAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[input.bracketAttr];\n      } else if (attrs.hasOwnProperty(input.bindonAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[input.bindonAttr];\n      } else if (attrs.hasOwnProperty(input.bracketParenAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[input.bracketParenAttr];\n      }\n      if (expr != null) {\n        const watchFn =\n            ((prop: any /** TODO #9100 */) =>\n                 (value: any /** TODO #9100 */, prevValue: any /** TODO #9100 */) => {\n                   if (this.inputChanges != null) {\n                     this.inputChangeCount++;\n                     this.inputChanges[prop] = new Ng1Change(prevValue, value);\n                   }\n                   this.component[prop] = value;\n                 })(input.prop);\n        this.componentScope.$watch(expr, watchFn);\n      }\n    }\n\n    const prototype = this.info.component.prototype;\n    if (prototype && (<OnChanges>prototype).ngOnChanges) {\n      // Detect: OnChanges interface\n      this.inputChanges = {};\n      this.componentScope.$watch(() => this.inputChangeCount, () => {\n        const inputChanges = this.inputChanges;\n        this.inputChanges = {};\n        (<OnChanges>this.component).ngOnChanges(inputChanges);\n      });\n    }\n    this.componentScope.$watch(() => this.changeDetector && this.changeDetector.detectChanges());\n  }\n\n  projectContent() {\n    const childNodes = this.childNodes;\n    const parent = this.contentInsertionPoint.parentNode;\n    if (parent) {\n      for (let i = 0, ii = childNodes.length; i < ii; i++) {\n        parent.insertBefore(childNodes[i], this.contentInsertionPoint);\n      }\n    }\n  }\n\n  setupOutputs() {\n    const attrs = this.attrs;\n    const outputs = this.info.outputs || [];\n    for (let j = 0; j < outputs.length; j++) {\n      const output = new PropertyBinding(outputs[j]);\n      let expr: any /** TODO #9100 */ = null;\n      let assignExpr = false;\n\n      const bindonAttr =\n          output.bindonAttr ? output.bindonAttr.substring(0, output.bindonAttr.length - 6) : null;\n      const bracketParenAttr = output.bracketParenAttr ?\n          `[(${output.bracketParenAttr.substring(2, output.bracketParenAttr.length - 8)})]` :\n          null;\n\n      if (attrs.hasOwnProperty(output.onAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[output.onAttr];\n      } else if (attrs.hasOwnProperty(output.parenAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[output.parenAttr];\n      } else if (attrs.hasOwnProperty(bindonAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[bindonAttr];\n        assignExpr = true;\n      } else if (attrs.hasOwnProperty(bracketParenAttr)) {\n        expr = (attrs as any /** TODO #9100 */)[bracketParenAttr];\n        assignExpr = true;\n      }\n\n      if (expr != null && assignExpr != null) {\n        const getter = this.parse(expr);\n        const setter = getter.assign;\n        if (assignExpr && !setter) {\n          throw new Error(`Expression '${expr}' is not assignable!`);\n        }\n        const emitter = this.component[output.prop] as EventEmitter<any>;\n        if (emitter) {\n          emitter.subscribe({\n            next: assignExpr ?\n                ((setter: any) => (v: any /** TODO #9100 */) => setter(this.scope, v))(setter) :\n                ((getter: any) => (v: any /** TODO #9100 */) =>\n                     getter(this.scope, {$event: v}))(getter)\n          });\n        } else {\n          throw new Error(\n              `Missing emitter '${output.prop}' on component '${this.info.component}'!`);\n        }\n      }\n    }\n  }\n\n  registerCleanup() {\n    this.element.bind('$destroy', () => {\n      this.componentScope.$destroy();\n      this.componentRef.destroy();\n    });\n  }\n}\n\nclass Ng1Change implements SimpleChange {\n  constructor(public previousValue: any, public currentValue: any) {}\n\n  isFirstChange(): boolean { return this.previousValue === this.currentValue; }\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}